<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/systems/PhysicSystem.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ClientHandle.js~ClientHandle.html">ClientHandle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Game.js~Game.html">Game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/GameModel.js~GameModel.html">GameModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/History.js~History.html">History</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/NetCodec.js~NetCodec.html">NetCodec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/RPC.js~RPC.html">RPC</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Scene.js~Scene.html">Scene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Server.js~Server.html">Server</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/System.js~System.html">System</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Timer.js~Timer.html">Timer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-uid">uid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-game">game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Keycodes">Keycodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Keynames">Keynames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aliases">aliases</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Log">Log</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rPC">rPC</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Camera.js~Camera.html">Camera</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/CircleShape.js~CircleShape.html">CircleShape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Physics.js~Physics.html">Physics</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/RawSprite.js~RawSprite.html">RawSprite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/RectangleShape.js~RectangleShape.html">RectangleShape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Shape.js~Shape.html">Shape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Sprite.js~Sprite.html">Sprite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Transform.js~Transform.html">Transform</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">drivers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/drivers/Graphics.js~Graphics.html">Graphics</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-graphics">graphics</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">systems</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/systems/GraphicSystem.js~GraphicSystem.html">GraphicSystem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/systems/PhysicSystem.js~PhysicSystem.html">PhysicSystem</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/systems/PhysicSystem.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import System from &apos;../System.js&apos;;
import { Log } from &apos;../Log.js&apos;;

export default class PhysicSystem extends System {

  constructor() {
    super();
    this._obj = [];
    this.buoyancy = 0.1;
    this.gravity = 0;
    this._boundaries = {
      left: -Infinity,
      right: Infinity,
      top: -Infinity,
      bottom: Infinity
    };
  }

  addObject(obj) {
    this._obj.push(obj);
    Log.info(`Physics: push object (length: ${this._obj.length})`);
  }

  removeObject(obj) {
    const idx = this._obj.indexOf(obj);
    if (idx &lt; 0) {
      Log.warn(&apos;Removing an object which is not in physcis system&apos;);
      return;
    }
    this._obj.splice(idx, 1);
    Log.info(`Physics: pop object (length: ${this._obj.length})`);
  }

  get boundaries() {
    return this._boundaries;
  }

  set boundaries(b) {
    if (b.left != null) this._boundaries.left = b.left;
    if (b.right != null) this._boundaries.right = b.right;
    if (b.top != null) this._boundaries.top = b.top;
    if (b.bottom != null) this._boundaries.bottom = b.bottom;
  }

  onUpdate(dt) {
    // Update all objects positions
    for (const obj of this._obj) {
      obj.transform.x += obj.vx * dt;
      obj.transform.y += obj.vy * dt;
      obj.transform.theta += obj.vtheta * dt;
    }

    // Na&#xEF;ve collision detection
    const objLength = this._obj.length;
    let i=0, j=0;
    for (i = 0 ; i &lt; objLength ; i++){
      const o1 = this._obj[i];
      // Test collision with terrain boundaries
      if (   o1.transform.x - o1.radius &lt;= this._boundaries.left
          || o1.transform.x + o1.radius &gt;= this._boundaries.right
          || o1.transform.y - o1.radius &lt;= this._boundaries.top
          || o1.transform.y + o1.radius &gt;= this._boundaries.bottom) {
        // If it is outside the terrain, adjust position and trigger collision
        const oldX = o1.transform.x;
        const oldY = o1.transform.y;

        o1.transform.x = Math.max(
            Math.min(o1.transform.x, this._boundaries.right - o1.radius),
            this._boundaries.left + o1.radius);
        o1.transform.y = Math.max(
            Math.min(o1.transform.y, this._boundaries.bottom - o1.radius),
            this._boundaries.top + o1.radius);

        o1.entity.triggerEvent(&apos;collision&apos;, {
          vx: (oldX != o1.transform.x) ? o1.vx : 0,
          vy: (oldY != o1.transform.y) ? o1.vy : 0,
          other: null
        });
      } else {
        // Otherwise (if still in terrain), test collision with other objects
        for (j = i+1 ; j &lt; objLength ; j++) {
          const o2 = this._obj[j];
          if (o1.transform.distanceTo(o2.transform) &lt; o1.radius + o2.radius) {
            o1.entity.triggerEvent(&apos;collision&apos;, {
              vx: o1.vx - o2.vx,
              vy: o1.vy - o2.vy,
              other: o2
            });
            o2.entity.triggerEvent(&apos;collision&apos;, {
              vx: o2.vx - o1.vx,
              vy: o2.vy - o1.vy,
              other: o1
            });
          }
        }
      }
    }
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
