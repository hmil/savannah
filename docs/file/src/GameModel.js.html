<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/GameModel.js | Savannah documentation API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ClientHandle.js~ClientHandle.html">ClientHandle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Game.js~Game.html">Game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/GameModel.js~GameModel.html">GameModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/History.js~History.html">History</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/NetCodec.js~NetCodec.html">NetCodec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/RPC.js~RPC.html">RPC</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Scene.js~Scene.html">Scene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Server.js~Server.html">Server</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/System.js~System.html">System</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Timer.js~Timer.html">Timer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-uid">uid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-game">game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Keycodes">Keycodes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Keynames">Keynames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-aliases">aliases</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Log">Log</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rPC">rPC</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">components</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Camera.js~Camera.html">Camera</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/CircleShape.js~CircleShape.html">CircleShape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Physics.js~Physics.html">Physics</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/RawSprite.js~RawSprite.html">RawSprite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/RectangleShape.js~RectangleShape.html">RectangleShape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Shape.js~Shape.html">Shape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Sprite.js~Sprite.html">Sprite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Transform.js~Transform.html">Transform</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">drivers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/drivers/Graphics.js~Graphics.html">Graphics</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-graphics">graphics</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">systems</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/systems/GraphicSystem.js~GraphicSystem.html">GraphicSystem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/systems/PhysicSystem.js~PhysicSystem.html">PhysicSystem</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/GameModel.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Entity from &apos;./Entity.js&apos;;
import game from &apos;./Game.js&apos;;
import { Log } from &apos;./Log.js&apos;;

export default class GameModel {

  constructor(scene) {
    this._scene = scene;
    this._entities = {};
    this._targetState = null;
  }

  /*
   * Inserts an entity into this model
   */
  addEntity(entity) {
    this._entities[entity.id] = entity;
  }

  removeEntity(entity) {
    delete this._entities[entity.id];
  }

  get entities() {
    return this._entities;
  }

  getEntity(id) {
    return this._entities[id] || null;
  }

  /*
   * Returns a serializable representation of this model at this moment
   */
  takeSnapshot() {
    const snap = {};
    for (const i of Object.keys(this._entities)) {
      const ent = this._entities[i];
      if (!ent.isSynchronized) {
        continue;
      }
      const serialized = {};
      for (const key of Object.keys(ent.components)) {
        const component = ent.components[key];
        serialized[key] = {
          name: component.constructor.name,
          attrs: component.attributes
        };
      }
      snap[ent.id] = {
        parent: (ent.parent == null) ? null : ent.parent.id,
        comps: serialized
      };
    }
    return snap;
  }

  /*
   * Updates this model using the provided diff
   */
  applyDiff(diff) {

  }

  /*
   * Transforms this model into the model described by the snapshot while trying to
   * reuse as much of the existing entities as possible
   */
  applySnapshot(snap) {
    const oldEntities = this._entities;
    this._entities = {};
    const collectedComps = [];

    const entitiesCreated = [];

    // Update entities or create them if necessary
    for (const i of Object.keys(snap)) {
      let entity = null;
      const snap_components = snap[i].comps;

      if(i in oldEntities) {
        entity = oldEntities[i];
        delete oldEntities[i];
      } else {
        entity = new Entity(this._scene, i);
        entitiesCreated.push(i);
      }

      const components = entity.components;

      this._entities[i] = entity;

      entity.parent = snap[i].parent;

      // Recycle existing components and purge those which disappeared
      for (const comp_id of Object.keys(components)) {
        if (comp_id in snap_components) {
          collectedComps.push(comp_id);
        } else {
          entity.removeComponent(comp_id);
        }
      }

      // Create new components if needed
      for (const comp_id of Object.keys(snap_components)) {
        var comp = entity.components[comp_id];
        if (comp == null) {
          comp = entity.addComponent(game.getComponent(snap_components[comp_id].name), comp_id);
        }
        comp.attributes = snap_components[comp_id].attrs;
      }

      collectedComps.length = 0;
    }

    // Update components
    // We do this in a second pass because of state consistency: i.e. we cannot update
    // references if they point to something which does not exist yet.
    // TODO: can we get rid of this loop?
    for (const i of Object.keys(snap)) {
      let entity = this._entities[i];
      if (entitiesCreated.indexOf(i) &gt;= 0) {
        entity.onCreate();
      }
    }

    // Remove other entities
    for (const i of Object.keys(oldEntities)) {
      oldEntities[i].onDestroy();
    }
  }


  update(dt) {
    // Logique:
    //
    // Si j&apos;ai un target state (qui a &#xE9;t&#xE9; donn&#xE9; grace a un diff/snap) dont le timestamp est
    // post&#xE9;rieur au timestamp local actuel, alors je regarde s&apos;il existe des entities
    // qui ne sont pas affect&#xE9;s par le target state (ie. ceux qui ont &#xE9;t&#xE9; cr&#xE9;&#xE9;s localement
    // et donc ne sont pas updat&#xE9;s par le serveur). Si c&apos;est le cas, je simule ces entities.
    // J&apos;interpole les attributes pour les autres entities.
    //
    if (this._targetState === null) {
      for (const i of Object.keys(this._entities)) {
        this._entities[i].onUpdate(dt);
      }
    } else {
      // TODO
    }
  }


}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
